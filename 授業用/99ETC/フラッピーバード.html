<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird クローン</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* カスタムCSS：Tailwindと組み合わせてゲームの雰囲気を出す */
        @import url('https://fonts.googleapis.com/css2?family=Bungee+Inline&family=Press+Start+2P&display=swap');

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #3b82f6; /* Tailwind blue-500 */
        }

        #game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        #gameCanvas {
            border: 4px solid #1f2937; /* Tailwind gray-800 */
            background-color: #7dd3fc; /* Tailwind sky-300 - 空の色 */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            touch-action: manipulation; /* モバイルでのデフォルトのジェスチャーを無効化 */
            cursor: pointer;
        }

        .game-title {
            font-family: 'Bungee Inline', cursive;
            color: #fcd34d; /* Tailwind amber-300 */
            text-shadow: 4px 4px 0 #1f2937;
            margin-bottom: 1rem;
        }

        .message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            padding: 30px 40px;
            background-color: rgba(255, 255, 255, 0.95);
            border: 6px solid #1f2937;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            text-align: center;
            display: none; /* 初期状態では非表示 */
        }

        .message-box h2 {
            font-size: 1.5rem;
            color: #ef4444; /* Tailwind red-500 */
            margin-bottom: 15px;
        }

        .message-box p {
            margin-bottom: 20px;
            font-size: 1rem;
        }

        .message-box button {
            background-color: #10b981; /* Tailwind emerald-500 */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
        }

        .message-box button:hover {
            background-color: #059669; /* Tailwind emerald-600 */
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="game-container" class="max-w-xl w-full">
        <h1 class="game-title text-3xl md:text-5xl font-extrabold mb-6">FLAPPY CANVAS</h1>
        <canvas id="gameCanvas" width="320" height="480" class="w-full max-w-sm aspect-[320/480]"></canvas>

        <div id="messageBox" class="message-box">
            <h2 id="messageTitle">ゲームオーバー</h2>
            <p id="messageScore" class="text-gray-700"></p>
            <p id="messageInstruction" class="text-sm text-gray-500 mt-4">スペースキーまたはクリックで再開</p>
            <button onclick="startGame()">再挑戦！</button>
        </div>
    </div>

    <script>
        // 即時実行関数式 (IIFE) を使用して、すべての変数をグローバルスコープから隔離します。
        (function() {
            
            // グローバル変数
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const W = canvas.width;
            const H = canvas.height;
            let gameLoopId;
            let isRunning = false;
            let score = 0;

            // ゲーム定数 (速度を全体的に遅くしました)
            const GRAVITY = 0.1; // 重力を弱く
            const JUMP = -4;    // ジャンプの勢いを弱く
            const PIPE_SPEED = 1.5; // パイプの移動速度を遅く
            const PIPE_WIDTH = 40;
            const PIPE_GAP = 210;
            const PIPE_SPACING = 150; // パイプ間の横の間隔

            // 鳥のオブジェクト
            let bird = {
                x: W / 4,
                y: H / 2,
                radius: 12,
                velocity: 0,
                color: '#fef08a' // Tailwind yellow-200
            };

            // パイプの配列
            let pipes = [];

            // 描画関数
            function drawBird() {
                ctx.beginPath();
                ctx.arc(bird.x, bird.y, bird.radius, 0, Math.PI * 2);
                ctx.fillStyle = bird.color;
                ctx.fill();
                ctx.strokeStyle = '#92400e'; // Tailwind amber-800
                ctx.lineWidth = 2;
                ctx.stroke();

                // 目を描画（シンプルに）
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(bird.x + bird.radius / 2, bird.y - bird.radius / 3, 2, 0, Math.PI * 2);
                ctx.fill();
            }

            function drawPipe(pipe) {
                ctx.fillStyle = '#10b981'; // Tailwind emerald-500
                ctx.strokeStyle = '#047857'; // Tailwind emerald-700
                ctx.lineWidth = 3;

                // 上パイプ
                ctx.fillRect(pipe.x, 0, PIPE_WIDTH, pipe.top);
                ctx.strokeRect(pipe.x, 0, PIPE_WIDTH, pipe.top);

                // 下パイプ
                ctx.fillRect(pipe.x, pipe.bottom, PIPE_WIDTH, H - pipe.bottom);
                ctx.strokeRect(pipe.x, pipe.bottom, PIPE_WIDTH, H - pipe.bottom);

                // パイプのヘッダー（太い部分）を描画
                const headerHeight = 15;
                ctx.fillStyle = '#065f46'; // Tailwind emerald-900
                // 上パイプヘッダー
                ctx.fillRect(pipe.x - 2, pipe.top - headerHeight, PIPE_WIDTH + 4, headerHeight);
                // 下パイプヘッダー
                ctx.fillRect(pipe.x - 2, pipe.bottom, PIPE_WIDTH + 4, headerHeight);
            }

            function drawScore() {
                ctx.fillStyle = '#1f2937';
                ctx.font = "bold 20px 'Press Start 2P', cursive";
                ctx.textAlign = 'left';
                ctx.fillText('SCORE: ' + score, 10, 30);
            }

            // ゲームロジック関数
            function updateBird() {
                bird.velocity += GRAVITY;
                bird.y += bird.velocity;
            }

            // ジャンプ処理
            function birdFlap() {
                if (isRunning) {
                    bird.velocity = JUMP;
                } else {
                    // ゲーム開始前にクリック/スペースが押された場合
                    startGame();
                }
            }

            function updatePipes() {
                // パイプの移動
                for (let i = 0; i < pipes.length; i++) {
                    pipes[i].x -= PIPE_SPEED;

                    // スコア判定: パイプを通過したか
                    if (!pipes[i].scored && pipes[i].x < bird.x - PIPE_WIDTH / 2) {
                        score++;
                        pipes[i].scored = true;
                    }
                }

                // 画面外のパイプを削除
                if (pipes.length > 0 && pipes[0].x < -PIPE_WIDTH) {
                    pipes.shift();
                }

                // 新しいパイプの生成
                // pipes.length === 0 のとき (ゲーム開始時や全パイプ削除後) または
                // 最後のパイプが一定の距離 (PIPE_SPACING) 移動したら新しいパイプを生成
                if (pipes.length === 0 || pipes[pipes.length - 1].x < W - PIPE_SPACING) {
                    generateNewPipe();
                }
            }

            function generateNewPipe() {
                // ランダムな隙間の位置を決定
                const minTop = 50;
                const maxTop = H - 50 - PIPE_GAP;
                const topHeight = Math.floor(Math.random() * (maxTop - minTop)) + minTop;

                pipes.push({
                    x: W,
                    top: topHeight,
                    bottom: topHeight + PIPE_GAP,
                    scored: false
                });
            }

            function checkCollision() {
                // 1. 地面または天井との衝突
                if (bird.y + bird.radius > H || bird.y - bird.radius < 0) {
                    gameOver();
                    return true;
                }

                // 2. パイプとの衝突
                for (let i = 0; i < pipes.length; i++) {
                    const p = pipes[i];

                    // 鳥がパイプのX軸範囲内にいるか
                    if (bird.x + bird.radius > p.x && bird.x - bird.radius < p.x + PIPE_WIDTH) {
                        // Y軸での衝突判定
                        const collisionWithTop = bird.y - bird.radius < p.top;
                        const collisionWithBottom = bird.y + bird.radius > p.bottom;

                        if (collisionWithTop || collisionWithBottom) {
                            gameOver();
                            return true;
                        }
                    }
                }
                return false;
            }

            // ゲームオーバー処理
            function gameOver() {
                isRunning = false;
                cancelAnimationFrame(gameLoopId);
                
                // メッセージボックスを表示
                const messageBox = document.getElementById('messageBox');
                document.getElementById('messageScore').innerText = `あなたのスコア: ${score}`;
                messageBox.style.display = 'block';

                // キー入力をリッスン
                document.addEventListener('keydown', restartOnKey, false);
                // 終了時にイベントリスナーを削除 (mousedown, touchstart, click)
                canvas.removeEventListener('mousedown', birdFlap, false); 
                canvas.removeEventListener('click', birdFlap, false); //念のためclickも削除
                canvas.removeEventListener('touchstart', birdFlap, false);
            }

            function restartOnKey(e) {
                if (e.code === 'Space' || e.key === ' ' || e.key === 'Enter') {
                    document.removeEventListener('keydown', restartOnKey, false);
                    startGame();
                }
            }

            // ゲーム初期化
            function resetGame() {
                bird.y = H / 2;
                bird.velocity = 0;
                pipes = []; // パイプの配列を空にする
                score = 0;
            }

            // ゲーム開始
            function startGame() {
                if (isRunning) return; // 既に実行中の場合は何もしない

                resetGame();
                isRunning = true;
                
                // メッセージボックスを非表示に
                document.getElementById('messageBox').style.display = 'none';

                // イベントリスナーを再登録
                document.addEventListener('keydown', handleInput, false);
                
                // マウス操作を「押した瞬間 (mousedown)」に設定
                canvas.addEventListener('mousedown', birdFlap, false);
                // タッチ操作は「触れた瞬間 (touchstart)」のまま
                canvas.addEventListener('touchstart', birdFlap, false);
                
                // ゲームループ開始
                gameLoop();
            }

            // HTMLのonclickから呼び出せるようにグローバルスコープに公開
            window.startGame = startGame;


            // 入力ハンドラ
            function handleInput(e) {
                if (e.code === 'Space' || e.key === ' ') {
                    e.preventDefault(); // スペースキーによるスクロールを防ぐ
                    birdFlap();
                }
            }

            // メインゲームループ
            function gameLoop() {
                // 画面をクリア
                ctx.clearRect(0, 0, W, H);

                if (isRunning) {
                    // ロジックの更新
                    updateBird();
                    updatePipes();
                    checkCollision();

                    // 描画
                    for (let i = 0; i < pipes.length; i++) {
                        drawPipe(pipes[i]);
                    }
                    drawBird();
                    drawScore();
                } else {
                    // ゲームオーバー時の描画（鳥を地面に固定）
                    // ただし、パイプは引き続き描画
                    for (let i = 0; i < pipes.length; i++) {
                        drawPipe(pipes[i]);
                    }
                    drawBird();
                    drawScore();
                }

                gameLoopId = requestAnimationFrame(gameLoop);
            }

            // 初回ロード時の処理
            window.onload = function() {
                // 初期画面設定
                document.getElementById('messageTitle').innerText = 'FLAPPY CANVAS';
                document.getElementById('messageScore').innerText = 'スペースキーまたはクリックで開始';
                document.getElementById('messageInstruction').innerText = '';
                document.getElementById('messageBox').style.display = 'block';
                
                // プリセットのリセット
                resetGame();
                
                // キー入力で即座に開始できるようにする
                document.addEventListener('keydown', restartOnKey, false);
                
                // マウス操作を「押した瞬間 (mousedown)」に設定
                canvas.addEventListener('mousedown', birdFlap, false);
                // タッチ操作は「触れた瞬間 (touchstart)」のまま
                canvas.addEventListener('touchstart', birdFlap, false);
                
                // ゲームループの初期呼び出し（描画のみ）
                gameLoop();
            };

            // レスポンシブ対応 (Canvasのサイズ調整はCSSでアスペクト比を維持して行い、JSは固定サイズW=320, H=480で処理を続行する)
            // ここでは処理の複雑化を避けるため、JavaScript側の内部サイズは固定(320x480)のままにしています。
        })(); // IIFE 終了
    </script>
</body>
</html>