<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼åˆ†å²ã™ã”ã‚ãã‚²ãƒ¼ãƒ </title>
    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š */
        @import url('https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@500;700&display=swap');

        /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #f0f8ff; /* è–„ã„æ°´è‰² */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ */
        .game-container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
            padding: 25px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            text-align: center;
            color: #4682b4; /* ã‚¹ãƒ†ã‚£ãƒ¼ãƒ«ãƒ–ãƒ«ãƒ¼ */
            border-bottom: 3px solid #b0c4de;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        /* çµ±è¨ˆæƒ…å ±ã‚¨ãƒªã‚¢ (ã‚¹ã‚³ã‚¢ã¨å›æ•°) */
        .stats-area {
            display: flex;
            justify-content: space-around;
            background-color: #ffe0b2; /* ãƒ”ãƒ¼ãƒ */
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            font-size: 1.1rem;
            font-weight: 700;
            color: #d2691e; /* ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆè‰² */
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ */
        #message-area {
            background-color: #e0ffff; /* è–„ã„ã‚·ã‚¢ãƒ³ */
            color: #1e90ff; /* ãƒ‰ã‚¸ãƒ£ãƒ¼ãƒ–ãƒ«ãƒ¼ */
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            text-align: center;
            min-height: 50px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        /* ã‚µã‚¤ã‚³ãƒ­ãƒœã‚¿ãƒ³ */
        #roll-dice-btn {
            background-color: #ff6347; /* ãƒˆãƒãƒˆè‰² */
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 700;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(255, 99, 71, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        /* ç¶šã‘ã‚‹/ã‚¤ãƒ™ãƒ³ãƒˆé©ç”¨ãƒœã‚¿ãƒ³ã®è£…é£¾ */
        #roll-dice-btn.continue-btn {
            background-color: #4CAF50; /* ç·‘è‰² */
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }
        #roll-dice-btn.continue-btn:hover:not(:disabled) {
            background-color: #45a049;
            box-shadow: 0 7px 18px rgba(76, 175, 80, 0.6);
        }

        /* é¸æŠè‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #choice-area {
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            flex-direction: column;
            gap: 10px;
            width: 100%;
            max-width: 400px;
            padding: 15px;
            border-radius: 15px;
            background-color: #f7e1c8; /* è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸ */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .choice-btn {
            background-color: #4682b4; /* ã‚¹ãƒ†ã‚£ãƒ¼ãƒ«ãƒ–ãƒ«ãƒ¼ */
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        }

        .choice-btn:hover:not(:disabled) {
            background-color: #5a9bd4;
            transform: translateY(-1px);
        }

        /* é¸æŠè‚¢çµæœã‚¨ãƒªã‚¢ (ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ãƒœã‚¿ãƒ³ã®ä»£ã‚ã‚Š) */
        #choice-result-area {
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            flex-direction: column;
            align-items: center;
            gap: 10px;
            padding: 15px;
            border-radius: 10px;
            background-color: #fce4ec; /* è–„ã„ãƒ”ãƒ³ã‚¯ */
            width: 100%;
            max-width: 400px;
        }

        #choice-roll-dice-btn {
            background-color: #ff9800; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(255, 152, 0, 0.4);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        #choice-roll-dice-btn:hover:not(:disabled) {
            background-color: #fb8c00;
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.6);
        }
        
        #choice-dice-result {
            font-size: 2rem;
            font-weight: 900;
            color: #d84315; /* ãƒ‡ã‚£ãƒ¼ãƒ—ã‚ªãƒ¬ãƒ³ã‚¸ */
            min-height: 30px;
        }
        
        /* é¸æŠè‚¢é–¢é€£ã®ç„¡åŠ¹åŒ– */
        .choice-btn:disabled, #choice-roll-dice-btn:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            box-shadow: none;
        }


        #roll-dice-btn:hover:not(:disabled) {
            background-color: #e5533c;
            transform: translateY(-2px);
            box-shadow: 0 7px 18px rgba(255, 99, 71, 0.6);
        }

        #roll-dice-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* ã‚µã‚¤ã‚³ãƒ­ã®ç›®è¡¨ç¤º */
        #dice-result {
            font-size: 2.5rem;
            font-weight: 900;
            color: #4682b4;
            min-height: 40px;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        /* ã‚µã‚¤ã‚³ãƒ­ã®ç›®å¼·èª¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã‚¯ãƒ©ã‚¹ */
        .dice-highlight {
            font-size: 4rem !important; /* ä¸€æ™‚çš„ã«å¤§ããã™ã‚‹ */
            color: #ff6347 !important; /* ãƒˆãƒãƒˆè‰²ã§å¼·èª¿ */
            transform: scale(1.1);
            opacity: 1;
        }


        /* ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ */
        .board {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5x5 = 25ãƒã‚¹ã«åˆã‚ã›ã‚‹ */
            gap: 5px;
            padding: 10px;
            background-color: #b0e0e6; /* ãƒ‘ã‚¦ãƒ€ãƒ¼ãƒ–ãƒ«ãƒ¼ */
            border-radius: 15px;
            border: 5px solid #4682b4;
        }

        /* ãƒã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .square {
            aspect-ratio: 1 / 1; /* ç¸¦æ¨ªæ¯”1:1ã®æ­£æ–¹å½¢ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #ffffff;
            border: 2px solid #aaa;
            border-radius: 8px;
            padding: 5px;
            box-sizing: border-box;
            text-align: center;
            position: relative;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        /* ãƒã‚¹ç•ªå· */
        .square-number {
            position: absolute;
            top: 2px;
            left: 5px;
            font-size: 0.7rem;
            color: #777;
        }

        /* ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆ */
        .square-event {
            font-size: 0.75rem;
            font-weight: bold;
            padding-top: 5px;
        }

        /* ç‰¹æ®Šãªãƒã‚¹ (ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹) */
        .square.event-move {
            background-color: #fffacd; /* ãƒ¬ãƒ¢ãƒ³ã‚·ãƒ•ã‚©ãƒ³ (é€²ã‚€) */
        }
        .square.event-back {
            background-color: #ffe4e1; /* ãƒŸã‚¹ãƒ†ã‚£ãƒ­ãƒ¼ã‚º (æˆ»ã‚‹) */
        }
        /* å¤ä»£ã®éºè·¡ãƒã‚¹ */
        .square.event-rest {
            background-color: #f0fff0; /* ãƒãƒ‹ãƒ¼ãƒ‡ãƒ¥ãƒ¼ */
            border: 3px solid #daa520; /* ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ­ãƒƒãƒ‰ã®å¤ªæ  */
        }
        /* ã‚¹ã‚³ã‚¢ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒã‚¹ */
        .square.event-treasure {
            background-color: #ffeb3b; /* ç¥ç€è‰² (å®ç®±) */
        }
        .square.event-thief {
            background-color: #bdbdbd; /* ã‚°ãƒ¬ãƒ¼ (ç›—è³Š) */
        }
        .square.event-kindness {
            background-color: #c8e6c9; /* ãƒ©ã‚¤ãƒˆã‚°ãƒªãƒ¼ãƒ³ (è¦ªåˆ‡) */
        }
        /* ã‚¹ãƒˆãƒ¼ãƒªãƒ¼åˆ†å²ãƒã‚¹ (New) */
        .square.event-choice {
            background-color: #add8e6; /* ãƒ©ã‚¤ãƒˆãƒ–ãƒ«ãƒ¼ */
            border: 3px solid #1e90ff; /* ãƒ‰ã‚¸ãƒ£ãƒ¼ãƒ–ãƒ«ãƒ¼ã®å¤ªæ  */
        }


        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒ»ã‚´ãƒ¼ãƒ« */
        .square.start {
            background-color: #98fb98; /* ãƒšãƒ¼ãƒ«ã‚°ãƒªãƒ¼ãƒ³ */
            font-weight: bold;
        }
        .square.goal {
            background-color: #ffb6c1; /* ãƒ©ã‚¤ãƒˆãƒ”ãƒ³ã‚¯ */
            font-weight: bold;
            border: 4px solid #ff69b4; /* ãƒ›ãƒƒãƒˆãƒ”ãƒ³ã‚¯ã®å¤ªæ  */
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ */
        .player-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            font-size: 1.5rem;
            animation: bounce 0.5s infinite alternate;
            z-index: 10;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç¾åœ¨åœ° */
        .square.active {
            box-shadow: 0 0 10px 3px #1e90ff; /* ãƒ‰ã‚¸ãƒ£ãƒ¼ãƒ–ãƒ«ãƒ¼ã®å…‰ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
            border: 2px solid #1e90ff;
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ« (ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—) ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .modal-overlay {
            /* å¸¸ã«ç”»é¢å…¨ä½“ã‚’è¦†ã† */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* åŠé€æ˜ã®é»’ */
            display: flex;
            justify-content: center;
            align-items: center;
            /* JSã§display: none; ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹ */
            z-index: 1000; 
            opacity: 0; /* åˆæœŸçŠ¶æ…‹ã§é€æ˜ */
            visibility: hidden; /* åˆæœŸçŠ¶æ…‹ã§éè¡¨ç¤º */
            transition: opacity 0.3s, visibility 0.3s;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«é©ç”¨ã•ã‚Œã‚‹ã‚¯ãƒ©ã‚¹ */
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            max-width: 90%;
            width: 400px;
            /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            transform: scale(0.8);
            transition: transform 0.3s ease-out;
        }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºæ™‚ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ‹¡å¤§ */
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }

        .modal-content h2 {
            color: #ff69b4; /* ãƒ›ãƒƒãƒˆãƒ”ãƒ³ã‚¯ */
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        
        #modal-final-score {
            margin-bottom: 30px;
        }

        #modal-close-btn {
            background-color: #1e90ff; /* ãƒ‰ã‚¸ãƒ£ãƒ¼ãƒ–ãƒ«ãƒ¼ */
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1rem;
            font-weight: 700;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        #modal-close-btn:hover {
            background-color: #1c7ed6;
            transform: translateY(-1px);
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œã®CSSã¯å‰å›ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ */
    </style>
</head>
<body>

<div class="game-container">
    <h1>ã‚¹ãƒˆãƒ¼ãƒªãƒ¼åˆ†å²ã™ã”ã‚ãï¼</h1>
    
    <!-- çµ±è¨ˆæƒ…å ±ã‚¨ãƒªã‚¢ -->
    <div class="stats-area">
        <div id="score-display" class="stat-item">ç¾åœ¨ã®ã‚¹ã‚³ã‚¢: 1000</div>
        <div id="roll-count-display" class="stat-item">æŒ¯ã£ãŸå›æ•°: 0å›</div>
    </div>

    <div id="message-area">ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>

    <div class="controls">
        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠè‚¢ã‚¨ãƒªã‚¢ -->
        <div id="choice-area">
            <!-- é¸æŠè‚¢ãƒœã‚¿ãƒ³ãŒJSã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>

        <!-- é¸æŠè‚¢çµæœã®ã‚µã‚¤ã‚³ãƒ­ã‚¨ãƒªã‚¢ -->
        <div id="choice-result-area">
            <div id="choice-message"></div>
            <button id="choice-roll-dice-btn">é‹å‘½ã®ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
            <div id="choice-dice-result"></div>
        </div>

        <!-- é€šå¸¸ã®æ“ä½œãƒœã‚¿ãƒ³ -->
        <button id="roll-dice-btn">ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹</button>
        <div id="dice-result"></div>
    </div>

    <div class="board" id="game-board">
        <!-- ãƒã‚¹ç›®ã¯JavaScriptã§ç”Ÿæˆã•ã‚Œã¾ã™ -->
    </div>
</div>

<!-- --- ã‚´ãƒ¼ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« --- -->
<div id="goal-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h2>ğŸ‰ ã‚´ãƒ¼ãƒ«ï¼ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ‰</h2>
        <div id="modal-final-score">
            <!-- æœ€çµ‚ã‚¹ã‚³ã‚¢ãŒJSã§æŒ¿å…¥ã•ã‚Œã¾ã™ -->
        </div>
        <!-- çµ‚äº†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã§ãã‚‹ã‚ˆã†ã«æ¡ˆå†…ã—ã¾ã™ -->
        <button id="modal-close-btn">ç¢ºèªã—ã¦ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹</button>
    </div>
</div>
<!-- --------------------- -->

<script>
    // --- ã‚²ãƒ¼ãƒ è¨­å®š ---
    // 25ãƒã‚¹ (0:ã‚¹ã‚¿ãƒ¼ãƒˆ, 1-23:é€šå¸¸ãƒã‚¹, 24:ã‚´ãƒ¼ãƒ«)
    const BOARD_SIZE = 24; // ãƒã‚¹ã®ç·æ•° (0ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆãƒã‚¹ã€BOARD_SIZEãŒã‚´ãƒ¼ãƒ«)
    const GOAL_POSITION = BOARD_SIZE;
    const playerIcon = 'ğŸ‘¤'; // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚¢ã‚¤ã‚³ãƒ³
    const MAX_REST_CHALLENGE = 10; // å†é–‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã®æœ€å¤§è©¦è¡Œå›æ•°
    const REST_SCORE_PER_TRY = 50; // 1è©¦è¡Œã‚ãŸã‚Šã®ã‚¹ã‚³ã‚¢å¤‰å‹•å€¤ (ãƒœãƒ¼ãƒŠã‚¹/ãƒšãƒŠãƒ«ãƒ†ã‚£)
    const BASE_BONUS = 5000; // æœ€çµ‚ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒŠã‚¹ã®åŸºæº–å€¤

    // ãƒã‚¹ç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾© (ãƒã‚¹ç•ªå·: {ã‚¿ã‚¤ãƒ—, åŠ¹æœ, èª¬æ˜, ã‚¹ãƒˆãƒ¼ãƒªãƒ¼, CSSã‚¯ãƒ©ã‚¹})
    // 1-indexed (ãƒã‚¹ç•ªå·1ã‹ã‚‰)
    const squareEvents = {
        // ã‚¹ã‚³ã‚¢ç²å¾—ã‚¤ãƒ™ãƒ³ãƒˆ
        3: { type: 'event-score', effect: 100, description: 'ç§˜å¯†ã®å®ç®±ã‚’ç™ºè¦‹ï¼', story: 'å¤ã„åœ°å›³ã«è¼‰ã£ã¦ã„ãŸç§˜å¯†ã®å®ç®±ã‚’ç™ºè¦‹ï¼é‡‘è²¨100æšã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼ğŸ’°', class: 'event-treasure' },
        
        // é¸æŠè‚¢ã‚¤ãƒ™ãƒ³ãƒˆ (NEW!)
        7: { 
            type: 'event-choice', 
            description: 'åˆ†ã‹ã‚Œé“ï¼šæ£®ã‹å·ã‹ï¼Ÿ', 
            story: 'é“ãŒäºŒã¤ã«åˆ†ã‹ã‚Œã¦ã„ã‚‹ã€‚ç¥ç§˜çš„ãªã€Œæ·±ã„æ£®ã€ã‚’è¡Œãã‹ã€ç©ã‚„ã‹ãªã€Œåºƒã„å·æ²¿ã„ã€ã‚’è¡Œãã‹ï¼ŸğŸ¤”', 
            class: 'event-choice',
            choices: [
                {
                    text: 'A. æ·±ã„æ£®ã‚’é€²ã‚€ (+1ãƒã‚¹ç¢ºå®š, é‹å‘½ã®ã‚µã‚¤ã‚³ãƒ­ã§å¤§åšæ‰“)',
                    consequence: {
                        move: 1, // ç¢ºå®šã§1ãƒã‚¹é€²ã‚€
                        rollType: 'score-chance',
                        // é‹å‘½ã®ã‚µã‚¤ã‚³ãƒ­åˆ¤å®š
                        rollMin: 4, // 4ä»¥ä¸Šã§æˆåŠŸ
                        rollMax: 6, // 6ãŒå‡ºãŸã‚‰è¶…å¤§å½“ãŸã‚Š
                        
                        // 4ã€œ5ãŒå‡ºãŸå ´åˆã®æˆåŠŸ
                        successScore: 500,
                        successMessage: 'æ£®ã®ç²¾éœŠã«å°ã‹ã‚Œã€å¹»ã®è–¬è‰ã‚’ç™ºè¦‹ï¼ã‚¹ã‚³ã‚¢500ç‚¹ç²å¾—ï¼',
                        
                        // 6ãŒå‡ºãŸå ´åˆã®è¶…å¤§å½“ãŸã‚Š
                        megaScore: 1500, 
                        megaMessage: 'éš ã•ã‚ŒãŸè–åŸŸã‚’ç™ºè¦‹ï¼ä¼èª¬ã®ç§˜å®ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼è¶…å¤§å½“ãŸã‚Šï¼',

                        // 1ã€œ3ãŒå‡ºãŸå ´åˆã®å¤±æ•—
                        failScore: -400,
                        failMessage: 'æ£®ã®é­”ç‰©ã«é“ã‚’å¡ãŒã‚Œã€å¤§äº‹ãªã‚¢ã‚¤ãƒ†ãƒ ã‚’å¥ªã‚ã‚ŒãŸ...',
                    }
                },
                {
                    text: 'B. åºƒã„å·æ²¿ã„ã‚’æ­©ã (+3ãƒã‚¹ç¢ºå®š, ã‚¹ã‚³ã‚¢å¤‰å‹•ãªã—)',
                    consequence: {
                        move: 3, // ç¢ºå®šã§3ãƒã‚¹é€²ã‚€
                        rollType: 'none',
                        successMessage: 'å·ã®æµã‚Œã«æ²¿ã£ã¦ã‚¹ãƒ ãƒ¼ã‚ºã«ç§»å‹•ã§ããŸã€‚å¿«é©ï¼',
                    }
                }
            ]
        },
        
        // å‰é€²ã‚¤ãƒ™ãƒ³ãƒˆ (New/Moved)
        5: { type: 'event-move', effect: 2, description: 'è¿½ã„é¢¨ï¼2ãƒã‚¹é€²ã‚€ï¼', story: 'çªç„¶ã®è¿½ã„é¢¨ï¼èˆ¹ãŒåŠ é€Ÿã—ã€ä¸€æ°—ã«2ãƒã‚¹å‰ã¸ï¼â›µ', class: 'event-move' },

        // å¤ä»£ã®éºè·¡ãƒã‚¹ (3ã‹æ‰€ã«é…ç½®) - ã“ã“ã¯ç‰¹æ®Šãªã‚µã‚¤ã‚³ãƒ­æŒ¯ã‚Šï¼ˆ4ä»¥ä¸Šï¼‰ãŒå¿…è¦ãªãŸã‚ã€æ—¢å­˜ã®turnToSkipã‚’ä½¿ç”¨
        8: { type: 'event-rest', effect: 1, description: `å¤ä»£ã®éºè·¡ãƒã‚¹`, story: 'å¤ä»£ã®çŸ³ç¢‘ãŒç«‹ã¡ã¯ã ã‹ã£ãŸï¼ãã“ã«åˆ»ã¾ã‚ŒãŸè¬ã‚’è§£ãã€å…ˆã«é€²ã‚€ã«ã¯ç‰¹åˆ¥ãªã‚µã‚¤ã‚³ãƒ­ã®ç›®ï¼ˆ4ä»¥ä¸Šï¼‰ãŒå¿…è¦ã ã€‚ğŸ“–', class: 'event-rest' },
        16: { type: 'event-rest', effect: 1, description: `å¤ä»£ã®éºè·¡ãƒã‚¹`, story: 'è¬ã®å¤ä»£ç¥æ®¿ã«è¿·ã„è¾¼ã‚“ã ï¼æ­£ã—ã„å‡ºå£ã‚’è¦‹ã¤ã‘ã‚‹ã«ã¯ã€è©¦ç·´ã®ã‚µã‚¤ã‚³ãƒ­ï¼ˆ4ä»¥ä¸Šï¼‰ã§é“ã‚’åˆ‡ã‚Šé–‹ã‘ï¼ğŸ—ï¸', class: 'event-rest' },
        22: { type: 'event-rest', effect: 1, description: `å¤ä»£ã®éºè·¡ãƒã‚¹`, story: 'å´©ã‚Œã‹ã‘ãŸå¤ä»£ã®åŸå¡è·¡ï¼æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸é€²ã‚€ãŸã‚ã®éµã¯ã€çŸ¥æµã¨é‹ã€‚ã‚µã‚¤ã‚³ãƒ­ï¼ˆ4ä»¥ä¸Šï¼‰ã§è©¦ç·´ã‚’çªç ´ã›ã‚ˆï¼ğŸ›¡ï¸', class: 'event-rest' },
        
        // å¾Œé€€ã‚¤ãƒ™ãƒ³ãƒˆ (Moved)
        11: { type: 'event-back', effect: -4, description: '4ãƒã‚¹æˆ»ã‚‹...', story: 'çªç„¶ã®åœŸç ‚å´©ã‚Œï¼å¼•ãè¿”ã•ã–ã‚‹ã‚’å¾—ãªã„... 4ãƒã‚¹å¾Œé€€ã€‚â›°ï¸', class: 'event-back' },
        // å‰é€²ã‚¤ãƒ™ãƒ³ãƒˆ (Moved)
        14: { type: 'event-move', effect: 5, description: 'ãƒ©ãƒƒã‚­ãƒ¼ï¼5ãƒã‚¹é€²ã‚€ï¼', story: 'é­”æ³•ä½¿ã„ã®å°ãï¼ãƒ¯ãƒ¼ãƒ—ãƒãƒ¼ã‚¿ãƒ«ã§ä¸€æ°—ã«5ãƒã‚¹å‰ã¸ï¼âœ¨', class: 'event-move' },
        // ã‚¹ã‚³ã‚¢æ¸›ç®—ã‚¤ãƒ™ãƒ³ãƒˆ (Moved)
        18: { type: 'event-score', effect: -150, description: 'ç›—è³Šå›£ã«é­é‡ï¼', story: 'å‡¶æ‚ªãªç›—è³Šå›£ã«é­é‡ã—ã¦ã—ã¾ã£ãŸï¼é‡‘è²¨150æšã‚’å¥ªã‚ã‚ŒãŸ... âš”ï¸', class: 'event-thief' },
        // å¾Œé€€ã‚¤ãƒ™ãƒ³ãƒˆ (Moved)
        20: { type: 'event-back', effect: -3, description: '3ãƒã‚¹æˆ»ã‚‹...', story: 'æ²¼åœ°ã«ã¯ã¾ã£ã¦ã—ã¾ã£ãŸï¼æŠœã‘å‡ºã™ã®ã«è‹¦åŠ´ã—ã€3ãƒã‚¹æˆ»ã‚‹ã€‚ğŸ’§', class: 'event-back' },
        // ã‚¹ã‚³ã‚¢ç²å¾—ã‚¤ãƒ™ãƒ³ãƒˆ (Moved)
        23: { type: 'event-score', effect: 200, description: 'è¦ªåˆ‡ãªæ—…äººã«å‡ºä¼šã†ï¼', story: 'è¦ªåˆ‡ãªæ—…äººã«é“ã¨é£Ÿæ–™ã‚’åˆ†ã‘ã¦ã‚‚ã‚‰ã„ã€å…ƒæ°—ãŒå‡ºã‚‹ï¼é‡‘è²¨200æšç²å¾—ï¼ğŸ’–', class: 'event-kindness' } 
    };

    // --- ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ---
    let playerPosition = 0;
    // turnToSkip: 1 (éºè·¡ãƒã‚¹ã§è©¦ç·´ä¸­), 0 (ç§»å‹•å¯èƒ½)
    let turnToSkip = 0; 
    // isPausedByEvent: true (é€šå¸¸ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºä¸­ã€‚ãƒœã‚¿ãƒ³ã§æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¸é€²ã‚€)
    let isPausedByEvent = false; 
    // isPausedByChoice: true (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé¸æŠè‚¢ã‚’é¸ã‚“ã§ã„ã‚‹çŠ¶æ…‹)
    let isPausedByChoice = false; 
    let eventToProcess = null; // å‡¦ç†ã‚’å¾…ã£ã¦ã„ã‚‹é€šå¸¸ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
    let choiceEventToProcess = null; // å‡¦ç†ã‚’å¾…ã£ã¦ã„ã‚‹é¸æŠè‚¢ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
    let currentChoiceConsequence = null; // é¸æŠè‚¢ã®çµæœ (ã‚µã‚¤ã‚³ãƒ­æŒ¯ã‚Šã‚’å¾…ã¤å ´åˆãŒã‚ã‚‹)
    let isGameOver = false;
    let diceRollCount = 0; // ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ãŸå›æ•° (ç§»å‹•ã‚’ä¼´ã†ã‚¿ãƒ¼ãƒ³ã®ã¿)
    let currentScore = 1000; // ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼ˆåˆæœŸå€¤ï¼‰
    let restChallengeCount = 0; // å¤ä»£ã®éºè·¡ãƒã‚¹ã§ã®è©¦è¡Œå›æ•°

    // --- DOMè¦ç´  ---
    const boardElement = document.getElementById('game-board');
    const messageArea = document.getElementById('message-area');
    const rollDiceBtn = document.getElementById('roll-dice-btn');
    const diceResultDisplay = document.getElementById('dice-result');
    const scoreDisplay = document.getElementById('score-display');
    const rollCountDisplay = document.getElementById('roll-count-display');
    
    // é¸æŠè‚¢é–¢é€£
    const choiceArea = document.getElementById('choice-area');
    const choiceResultArea = document.getElementById('choice-result-area');
    const choiceRollDiceBtn = document.getElementById('choice-roll-dice-btn');
    const choiceDiceResultDisplay = document.getElementById('choice-dice-result');
    const choiceMessageDisplay = document.getElementById('choice-message');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã®å–å¾—
    const goalModal = document.getElementById('goal-modal');
    const modalFinalScore = document.getElementById('modal-final-score');
    const modalCloseBtn = document.getElementById('modal-close-btn');

    // --- é–¢æ•°å®šç¾© ---

    /**
     * ã‚¹ã‚³ã‚¢ã¨ã‚µã‚¤ã‚³ãƒ­å›æ•°ã®UIã‚’æ›´æ–°ã—ã¾ã™ã€‚
     */
    function updateStatsUI() {
        scoreDisplay.textContent = `ç¾åœ¨ã®ã‚¹ã‚³ã‚¢: ${currentScore}`;
        rollCountDisplay.textContent = `æŒ¯ã£ãŸå›æ•°: ${diceRollCount}å›`;
    }

    /**
     * ã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã‚’åˆæœŸåŒ–ã—ã€DOMã«æç”»ã—ã¾ã™ã€‚
     */
    function initializeBoard() {
        boardElement.innerHTML = ''; // ãƒœãƒ¼ãƒ‰ã‚’ã‚¯ãƒªã‚¢

        // 0 (ã‚¹ã‚¿ãƒ¼ãƒˆ) ã‹ã‚‰ BOARD_SIZE (ã‚´ãƒ¼ãƒ«æ‰‹å‰) ã¾ã§ã®ãƒã‚¹ã‚’ç”Ÿæˆ
        for (let i = 0; i < BOARD_SIZE; i++) {
            const square = document.createElement('div');
            square.classList.add('square');
            square.dataset.index = i; // ãƒã‚¹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ (0å§‹ã¾ã‚Š)

            const numberSpan = document.createElement('span');
            numberSpan.classList.add('square-number');
            numberSpan.textContent = i === 0 ? 'START' : i;

            const eventSpan = document.createElement('span');
            eventSpan.classList.add('square-event');

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã®å ´åˆ
            const eventInfo = squareEvents[i];
            if (eventInfo) {
                // eventInfo.classã«æ ¼ç´ã•ã‚ŒãŸCSSã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                square.classList.add(eventInfo.class);
                eventSpan.textContent = eventInfo.description;
            }

            if (i === 0) {
                square.classList.add('start');
                numberSpan.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
            }

            square.appendChild(numberSpan);
            square.appendChild(eventSpan);
            boardElement.appendChild(square);
        }

        // ã‚´ãƒ¼ãƒ«ãƒã‚¹ã‚’ç”Ÿæˆ (BOARD_SIZEç•ªç›®)
        const goalSquare = document.createElement('div');
        goalSquare.classList.add('square', 'goal');
        goalSquare.dataset.index = GOAL_POSITION;
        goalSquare.innerHTML = '<span class="square-number">GOAL</span><span class="square-event">ãŠã‚ã§ã¨ã†ï¼</span>';
        boardElement.appendChild(goalSquare);

        updateStatsUI(); // åˆæœŸçµ±è¨ˆæƒ…å ±ã‚’è¡¨ç¤º
    }

    /**
     * ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹ (1ã€œ6)
     * @returns {number} ã‚µã‚¤ã‚³ãƒ­ã®ç›®
     */
    function rollDice() {
        return Math.floor(Math.random() * 6) + 1;
    }

    /**
     * ã‚µã‚¤ã‚³ãƒ­ã®ç›®ã‚’å¼·èª¿è¡¨ç¤ºã—ã¾ã™
     * @param {number} steps - ã‚µã‚¤ã‚³ãƒ­ã®ç›®
     * @param {string} prefix - è¡¨ç¤ºã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã®æ¥é ­è¾
     * @param {HTMLElement} displayElement - çµæœã‚’è¡¨ç¤ºã™ã‚‹DOMè¦ç´ 
     */
    function displayDiceRoll(steps, prefix = '', displayElement = diceResultDisplay) {
        // ã‚µã‚¤ã‚³ãƒ­ã®ç›®ã‚’å¤§ããå¼·èª¿è¡¨ç¤º
        displayElement.textContent = prefix + steps;
        displayElement.classList.add('dice-highlight');
        
        // 1ç§’å¾Œã«å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã«æˆ»ã™
        setTimeout(() => {
            displayElement.classList.remove('dice-highlight');
            // ãƒãƒ£ãƒ¬ãƒ³ã‚¸ä¸­ã§ã¯ãªã„å ´åˆã€çµæœè¡¨ç¤ºã¯ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹
            if (turnToSkip === 0 && !isPausedByEvent && !isPausedByChoice) {
                diceResultDisplay.textContent = ''; 
            }
        }, 1000);
    }


    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç§»å‹•ã•ã›ã€ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã—ã¾ã™ã€‚
     * @param {number} steps - ç§»å‹•ã™ã‚‹æ­©æ•°
     */
    function movePlayer(steps) {
        // ã‚µã‚¤ã‚³ãƒ­ã®ç›®ã‚’è¡¨ç¤º
        displayDiceRoll(steps);

        let newPosition = playerPosition + steps;
        
        messageArea.textContent = `${steps}ãŒå‡ºã¾ã—ãŸï¼${steps}ãƒã‚¹é€²ã¿ã¾ã™ã€‚`;
        
        let isGoal = false; // ã‚´ãƒ¼ãƒ«åˆ¤å®šãƒ•ãƒ©ã‚°
        
        // ã‚´ãƒ¼ãƒ«ã‚’ã‚ªãƒ¼ãƒãƒ¼ã—ãŸå ´åˆã€ã‚´ãƒ¼ãƒ«ã«æ­¢ã¾ã‚‹ï¼ˆçªãå½“ãŸã‚Šãƒ«ãƒ¼ãƒ«ï¼‰
        if (newPosition >= GOAL_POSITION) {
            newPosition = GOAL_POSITION;
            isGoal = true;
        }
        
        // 0æœªæº€ã«æˆ»ã‚‹å ´åˆã€ã‚¹ã‚¿ãƒ¼ãƒˆ (0) ã«æ­¢ã¾ã‚‹
        if (newPosition < 0) {
            newPosition = 0;
        }

        playerPosition = newPosition;

        // UIã‚’æ›´æ–° (ã‚´ãƒ¼ãƒ«ã®å ´åˆã‚‚ã“ã“ã§ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚´ãƒ¼ãƒ«ãƒã‚¹ã«ç§»å‹•ã•ã›ã‚‹)
        updateBoardUI();

        if (isGoal) {
            // ã‚´ãƒ¼ãƒ«æ™‚ã¯ã€messageAreaã®æ›´æ–°ã¯endGameã«ä»»ã›ã‚‹
            endGame(); 
            return;
        }

        // ãƒã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®ç¢ºèª (ã‚¹ã‚¿ãƒ¼ãƒˆ(0)ã¨ã‚´ãƒ¼ãƒ«(GOAL_POSITION)ã¯ã‚¤ãƒ™ãƒ³ãƒˆãªã—)
        if (playerPosition > 0 && playerPosition < GOAL_POSITION) {
            // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã¯ã‚µã‚¤ã‚³ãƒ­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«å®Ÿè¡Œ
            setTimeout(() => {
                 handleSquareEvent(playerPosition);
            }, 1500);
        } else {
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã§ã¯ãªã‹ã£ãŸå ´åˆã€æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚ã‚‹ã‚ˆã†ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹
            setTimeout(() => {
                // ç§»å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã€Œç¶šã‘ã‚‹ã€ã§é–‰ã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
                isPausedByEvent = true;
                messageArea.textContent = `ç¾åœ¨åœ°: ${playerPosition}ã€‚æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€ã«ã¯ã€Œç¶šã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`;
                updateRollButtonState();
            }, 1500);
        }
    }

    /**
     * ç¾åœ¨ã®ãƒã‚¹ç›®ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã—ã¾ã™ã€‚
     * @param {number} position - ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä½ç½®
     */
    function handleSquareEvent(position) {
        const eventInfo = squareEvents[position];

        if (eventInfo) {
            messageArea.textContent = `[ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ!] ${eventInfo.story}`;

            if (eventInfo.type === 'event-choice') {
                // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼åˆ†å²ã‚¤ãƒ™ãƒ³ãƒˆ
                isPausedByChoice = true;
                choiceEventToProcess = eventInfo;
                handleChoiceEvent(eventInfo);
            } else if (eventInfo.type === 'event-rest') {
                // å¤ä»£ã®éºè·¡ãƒã‚¹ (å†é–‹ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å¾…ã¤çŠ¶æ…‹ã«è¨­å®š)
                turnToSkip = 1; 
                restChallengeCount = 0; // è©¦è¡Œå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                messageArea.textContent += ` å†é–‹ã®ãŸã‚ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãŒå¿…è¦ã§ã™ã€‚ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ãã ã•ã„ï¼`;
            } else {
                // é€šå¸¸ã‚¤ãƒ™ãƒ³ãƒˆ (ç§»å‹•/ã‚¹ã‚³ã‚¢) ã¯ä¸€æ™‚åœæ­¢çŠ¶æ…‹ã«ã™ã‚‹
                eventToProcess = eventInfo;
                isPausedByEvent = true; 
                messageArea.textContent += ` ã€Œç¶šã‘ã‚‹ã€ã§åŠ¹æœã‚’é©ç”¨ã—ã¾ã™ã€‚`;
            }
            
            // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
            updateRollButtonState();
        } else {
             // ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã¯ movePlayer ã®æœ€å¾Œã§ isPausedByEvent ãŒ true ã«è¨­å®šã•ã‚Œã‚‹
             updateRollButtonState(); 
        }
    }
    
    // --- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼åˆ†å²é–¢é€£ã®é–¢æ•° ---
    
    /**
     * é¸æŠè‚¢ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†ã—ã€UIã«é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
     * @param {object} eventInfo - é¸æŠè‚¢ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±
     */
    function handleChoiceEvent(eventInfo) {
        choiceArea.innerHTML = ''; // æ—¢å­˜ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªã‚¢
        
        eventInfo.choices.forEach((choice, index) => {
            const button = document.createElement('button');
            button.classList.add('choice-btn');
            button.textContent = choice.text;
            button.dataset.choiceIndex = index;
            button.addEventListener('click', () => processChoice(index));
            choiceArea.appendChild(button);
        });
        
        updateChoiceUI(); // é¸æŠè‚¢UIã‚’è¡¨ç¤ºçŠ¶æ…‹ã«
    }

    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒé¸æŠè‚¢ã‚’é¸ã‚“ã å¾Œã®å‡¦ç†ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
     * @param {number} choiceIndex - é¸ã°ã‚ŒãŸé¸æŠè‚¢ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
     */
    function processChoice(choiceIndex) {
        if (!choiceEventToProcess) return;

        const choice = choiceEventToProcess.choices[choiceIndex];
        currentChoiceConsequence = choice.consequence;
        
        // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã‚’ã™ã¹ã¦ç„¡åŠ¹åŒ– (äºŒé‡ã‚¯ãƒªãƒƒã‚¯é˜²æ­¢)
        document.querySelectorAll('.choice-btn').forEach(btn => btn.disabled = true);
        
        // ç¢ºå®šç§»å‹•
        const moveEffect = currentChoiceConsequence.move || 0;
        let nextPosition = playerPosition + moveEffect;
        let finalMessage = '';

        // ç§»å‹•ã‚’é©ç”¨
        if (moveEffect !== 0) {
            if (nextPosition >= GOAL_POSITION) {
                nextPosition = GOAL_POSITION;
            }
            if (nextPosition < 0) {
                nextPosition = 0;
            }
            playerPosition = nextPosition;
            updateBoardUI();
            
            finalMessage += `${Math.abs(moveEffect)}ãƒã‚¹${moveEffect > 0 ? 'é€²ã¿' : 'æˆ»ã‚Š'}ã¾ã—ãŸã€‚`;
        }

        // ã‚µã‚¤ã‚³ãƒ­ã«ã‚ˆã‚‹è¿½åŠ ã®é‹è©¦ã—ãŒå¿…è¦ã‹ç¢ºèª
        if (currentChoiceConsequence.rollType === 'score-chance') {
            // ã‚µã‚¤ã‚³ãƒ­ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤ºã—ã€é‹è©¦ã—ã‚’ä¿ƒã™
            choiceResultArea.style.display = 'flex';
            choiceRollDiceBtn.disabled = false;
            choiceMessageDisplay.textContent = `${finalMessage} ã•ã‚‰ã«é‹å‘½ã®ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ã€è¿½åŠ ã®ãƒœãƒ¼ãƒŠã‚¹ã‚’æ±ºã‚ã¾ã—ã‚‡ã†ï¼`;
            choiceArea.style.display = 'none'; // é¸æŠè‚¢ã‚’éè¡¨ç¤ºã«
        } else {
            // ã‚µã‚¤ã‚³ãƒ­ä¸è¦ã€ç¢ºå®šã§çµ‚äº†
            const successMessage = currentChoiceConsequence.successMessage || 'ç‰¹ã«ä½•ã‚‚èµ·ã“ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
            messageArea.textContent = `[é¸æŠçµæœ] ${choice.text} ã®çµæœã€${successMessage} ${finalMessage}`;

            // æœ€çµ‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå¾Œã€é€šå¸¸ã‚¿ãƒ¼ãƒ³ã¸æˆ»ã‚‹
            isPausedByChoice = false;
            currentChoiceConsequence = null;
            choiceEventToProcess = null;
            updateChoiceUI(); // UIã‚’ãƒªã‚»ãƒƒãƒˆ
            
            // ã‚´ãƒ¼ãƒ«åˆ¤å®š
            if (playerPosition === GOAL_POSITION) {
                endGame();
            } else {
                // æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€
                isPausedByEvent = true;
                messageArea.textContent += ' ã€Œç¶šã‘ã‚‹ã€ã§æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚“ã§ãã ã•ã„ã€‚';
                updateRollButtonState();
            }
        }
    }

    /**
     * é¸æŠè‚¢ã«ç¶šãã‚µã‚¤ã‚³ãƒ­ã®çµæœã‚’å‡¦ç†ã—ã¾ã™ã€‚
     */
    function handleChoiceRoll() {
        if (!currentChoiceConsequence) return;

        choiceRollDiceBtn.disabled = true;

        const rollResult = rollDice();
        // é¸æŠè‚¢ç”¨ã®ã‚µã‚¤ã‚³ãƒ­çµæœã‚’è¡¨ç¤º
        displayDiceRoll(rollResult, '', choiceDiceResultDisplay);

        const rollData = currentChoiceConsequence;
        let finalMessage = '';
        let scoreChange = 0;

        setTimeout(() => {
            if (rollResult >= rollData.rollMax) {
                // è¶…å¤§å½“ãŸã‚Š (6ã®å ´åˆ)
                scoreChange = rollData.megaScore;
                finalMessage = `é‹å‘½ã®ã‚µã‚¤ã‚³ãƒ­ã§ã€${rollResult}ã€‘ãŒå‡ºãŸï¼ğŸ‰ ${rollData.megaMessage} ã‚¹ã‚³ã‚¢${scoreChange}ç‚¹ç²å¾—ï¼`;
            } else if (rollResult >= rollData.rollMin) {
                // æˆåŠŸ (4ã€œ5ã®å ´åˆ)
                scoreChange = rollData.successScore;
                finalMessage = `é‹å‘½ã®ã‚µã‚¤ã‚³ãƒ­ã§ã€${rollResult}ã€‘ãŒå‡ºãŸï¼âœ¨ ${rollData.successMessage} ã‚¹ã‚³ã‚¢${scoreChange}ç‚¹ç²å¾—ï¼`;
            } else {
                // å¤±æ•— (1ã€œ3ã®å ´åˆ)
                scoreChange = rollData.failScore;
                finalMessage = `é‹å‘½ã®ã‚µã‚¤ã‚³ãƒ­ã§ã€${rollResult}ã€‘ãŒå‡ºãŸ... ğŸ˜­ ${rollData.failMessage} ã‚¹ã‚³ã‚¢${Math.abs(scoreChange)}ç‚¹å¤±ã£ãŸ...`;
            }
            
            currentScore += scoreChange;
            updateStatsUI();
            
            // ã‚¹ã‚³ã‚¢å¤‰å‹•ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«è¿½åŠ 
            messageArea.textContent = `[é¸æŠçµæœ] ${finalMessage} ã€Œç¶šã‘ã‚‹ã€ã§æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚“ã§ãã ã•ã„ã€‚`;
            
            // é¸æŠè‚¢ã¨ã‚µã‚¤ã‚³ãƒ­çµæœã®UIã‚’ãƒªã‚»ãƒƒãƒˆã—ã€é€šå¸¸ã‚¿ãƒ¼ãƒ³ã¸æˆ»ã‚‹æº–å‚™
            isPausedByChoice = false;
            isPausedByEvent = true; // ã€Œç¶šã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã§æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚€
            currentChoiceConsequence = null;
            choiceEventToProcess = null;
            updateChoiceUI();
            updateRollButtonState();
        }, 1500);
    }
    
    /**
     * é¸æŠè‚¢é–¢é€£ã®UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚
     */
    function updateChoiceUI() {
        if (isPausedByChoice) {
            choiceArea.style.display = 'flex';
            choiceResultArea.style.display = 'none';
            rollDiceBtn.style.display = 'none'; // é€šå¸¸ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
            diceResultDisplay.style.display = 'none'; // é€šå¸¸ã‚µã‚¤ã‚³ãƒ­ã‚’éè¡¨ç¤º
            messageArea.style.backgroundColor = '#add8e6'; // é¸æŠè‚¢ã‚¤ãƒ™ãƒ³ãƒˆè‰²
        } else {
            choiceArea.style.display = 'none';
            choiceArea.innerHTML = '';
            choiceResultArea.style.display = 'none';
            choiceDiceResultDisplay.textContent = '';
            choiceMessageDisplay.textContent = '';

            rollDiceBtn.style.display = 'block'; // é€šå¸¸ãƒœã‚¿ãƒ³ã‚’å†è¡¨ç¤º
            diceResultDisplay.style.display = 'block'; // é€šå¸¸ã‚µã‚¤ã‚³ãƒ­ã‚’å†è¡¨ç¤º
            messageArea.style.backgroundColor = '#e0ffff'; // é€šå¸¸è‰²ã«æˆ»ã™
        }
    }
    // --- é¸æŠè‚¢é–¢é€£ã®é–¢æ•° çµ‚ã‚ã‚Š ---
    

    /**
     * isPausedByEvent ãŒ true ã®å ´åˆã«ã€ã‚¤ãƒ™ãƒ³ãƒˆåŠ¹æœã‚’é©ç”¨ã—ã€ã‚²ãƒ¼ãƒ ã‚’å†é–‹ã—ã¾ã™ã€‚
     */
    function continueAfterEvent() {
        isPausedByEvent = false;
        let finalMessage = '';

        if (eventToProcess) {
            const eventInfo = eventToProcess;
            
            if (eventInfo.type === 'event-move' || eventInfo.type === 'event-back') {
                // ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
                let moveEffect = eventInfo.effect;
                let nextPosition = playerPosition + moveEffect;
                
                // 0æœªæº€ã«æˆ»ã‚‹å ´åˆã€ã‚¹ã‚¿ãƒ¼ãƒˆ (0) ã«æ­¢ã¾ã‚‹
                if (nextPosition < 0) {
                    nextPosition = 0;
                }
                
                let eventCausedGoal = false;
                // ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚´ãƒ¼ãƒ«ã«åˆ°é”ã™ã‚‹å ´åˆ
                if (nextPosition >= GOAL_POSITION) {
                    nextPosition = GOAL_POSITION;
                    eventCausedGoal = true;
                }

                playerPosition = nextPosition;
                updateBoardUI();
                
                if (eventCausedGoal) {
                    // ã‚¤ãƒ™ãƒ³ãƒˆã§ã‚´ãƒ¼ãƒ«ã—ãŸå ´åˆã‚‚endGameã‚’å‘¼ã³å‡ºã—ã€ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                    endGame();
                    return; // ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
                } else {
                     finalMessage = `${moveEffect > 0 ? moveEffect + 'ãƒã‚¹é€²ã¿ã¾ã—ãŸï¼' : Math.abs(moveEffect) + 'ãƒã‚¹æˆ»ã‚Šã¾ã—ãŸï¼'} æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚“ã§ãã ã•ã„ã€‚`;
                }

            } else if (eventInfo.type === 'event-score') {
                // ã‚¹ã‚³ã‚¢å¤‰å‹•ã‚¤ãƒ™ãƒ³ãƒˆ
                const scoreChange = eventInfo.effect;
                currentScore += scoreChange;
                updateStatsUI(); // ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
                
                const changeText = scoreChange > 0 ? `${scoreChange}ç‚¹ç²å¾—ï¼` : `${Math.abs(scoreChange)}ç‚¹å¤±ã£ãŸ...`;
                finalMessage = `(ã‚¹ã‚³ã‚¢å¤‰å‹•: ${changeText})ã€‚æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚“ã§ãã ã•ã„ã€‚`;
            }
            
            messageArea.textContent = eventInfo.story + ' ' + finalMessage;
            eventToProcess = null; // å‡¦ç†å®Œäº†
            
        } else {
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹ã§ãªã‹ã£ãŸå ´åˆã®ã€Œç¶šã‘ã‚‹ã€
            messageArea.textContent = 'æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã§ã™ã€‚ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ãã ã•ã„ï¼';
        }

        // ç¶šã‘ã¦ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        updateRollButtonState();
    }
    
    /**
     * å¤ä»£ã®éºè·¡ãƒã‚¹ã«ã„ã‚‹ã¨ãã€å†é–‹ã®ãŸã‚ã«ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹å‡¦ç†
     */
    function handleRestRoll() {
        // ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹
        const escapeRoll = rollDice();
        
        // ã‚µã‚¤ã‚³ãƒ­ã®ç›®ã‚’è¡¨ç¤º (prefixä»˜ã)
        displayDiceRoll(escapeRoll, 'è©¦ç·´: ');

        if (restChallengeCount >= MAX_REST_CHALLENGE) {
            messageArea.textContent = `[ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¤±æ•—] è©¦è¡Œå›æ•°(${MAX_REST_CHALLENGE}å›)ã‚’è¶…ãˆã€çŸ³ç¢‘ã®å‘ªã„ãŒç™ºå‹•ï¼ã‚¹ã‚³ã‚¢ã‚’å¤§ããå¤±ã„ã€å¼·åˆ¶çš„ã«å†é–‹...`;
            currentScore -= REST_SCORE_PER_TRY * MAX_REST_CHALLENGE * 2; // å¤§ããªãƒšãƒŠãƒ«ãƒ†ã‚£
            turnToSkip = 0; // å¼·åˆ¶å†é–‹
            updateStatsUI();
            updateRollButtonState();
            return;
        }

        // è©¦è¡Œå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        restChallengeCount++; 
        
        let scoreChange = 0;
        let messageSuffix = '';

        if (escapeRoll >= 4) {
            // å†é–‹æˆåŠŸ
            turnToSkip = 0;

            // è©¦è¡Œå›æ•°ã«å¿œã˜ãŸç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹è¨ˆç®—
            const bonusMultiplier = MAX_REST_CHALLENGE - restChallengeCount + 1;
            const restBonus = bonusMultiplier * REST_SCORE_PER_TRY;
            currentScore += restBonus;
            scoreChange = restBonus;

            messageArea.textContent = `è¦‹äº‹ã€çŸ³ç¢‘ã®è¬ã‚’è§£ãã€å¤ä»£ã®åŠ›ã‚’æ‰‹ã«å…¥ã‚ŒãŸï¼ğŸ‰ (è©¦è¡Œ${restChallengeCount}å›ã§æˆåŠŸ)`;
            messageSuffix = `ç‰¹åˆ¥ãƒœãƒ¼ãƒŠã‚¹: ${restBonus}ç‚¹ç²å¾—ï¼`;

        } else {
            // å†é–‹å¤±æ•— (è©¦è¡Œå›æ•°ã«å¿œã˜ã¦ãƒšãƒŠãƒ«ãƒ†ã‚£)
            scoreChange = -REST_SCORE_PER_TRY;
            currentScore += scoreChange;

            messageArea.textContent = `æ®‹å¿µã€è¬ã¯è§£ã‘ãªã‹ã£ãŸ... (è©¦è¡Œ${restChallengeCount}å›ç›®, è©¦ç·´ã®çµæœ: ${escapeRoll})`;
            messageSuffix = `${Math.abs(scoreChange)}ç‚¹å¤±ã£ãŸã€‚ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã ï¼`;
        }

        updateStatsUI(); // ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
        
        // ã‚µã‚¤ã‚³ãƒ­è¡¨ç¤ºã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°ã—ã€ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
        setTimeout(() => {
            messageArea.textContent += ` ${messageSuffix}`;
            updateRollButtonState(); 
        }, 1500);
    }

    
    /**
     * ã‚µã‚¤ã‚³ãƒ­ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã—ã¾ã™ã€‚
     */
    function updateRollButtonState() {
        rollDiceBtn.classList.remove('continue-btn'); // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        if (isGameOver) {
            rollDiceBtn.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
            rollDiceBtn.disabled = true;
            return;
        }
        
        if (isPausedByChoice) {
            // é¸æŠè‚¢ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿä¸­ã®å ´åˆã€é€šå¸¸ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            rollDiceBtn.disabled = true;
            rollDiceBtn.style.display = 'none';
            return;
        }

        // é¸æŠè‚¢ãŒãªã„å ´åˆã¯é€šå¸¸ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        rollDiceBtn.style.display = 'block';

        if (turnToSkip > 0) {
            // å¤ä»£ã®éºè·¡ãƒã‚¹ã«ã„ã‚‹ (è©¦ç·´ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹çŠ¶æ…‹)
            if (restChallengeCount < MAX_REST_CHALLENGE) {
                rollDiceBtn.textContent = `éºè·¡ã®è©¦ç·´ã«æŒ‘ã‚€ (è©¦è¡Œ${restChallengeCount}/${MAX_REST_CHALLENGE}å›)`;
                rollDiceBtn.disabled = false;
            } else {
                 rollDiceBtn.textContent = `ãƒãƒ£ãƒ¬ãƒ³ã‚¸å¤±æ•— - å¼·åˆ¶å†é–‹`;
                 rollDiceBtn.disabled = false;
            }
            messageArea.style.backgroundColor = '#ffc0cb'; // ãƒ”ãƒ³ã‚¯
            diceResultDisplay.textContent = ''; // è©¦ç·´ä¸­ã¯ã‚µã‚¤ã‚³ãƒ­ã®ç›®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        } else if (isPausedByEvent) {
            // é€šå¸¸ã®ç§»å‹•å®Œäº†å¾Œ or ã‚¤ãƒ™ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºå¾Œ (ç¶šã‘ã‚‹çŠ¶æ…‹)
            rollDiceBtn.textContent = 'ç¶šã‘ã‚‹';
            rollDiceBtn.disabled = false;
            rollDiceBtn.classList.add('continue-btn'); // ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«
            messageArea.style.backgroundColor = '#fffacd'; // ãƒ¬ãƒ¢ãƒ³ã‚·ãƒ•ã‚©ãƒ³
            diceResultDisplay.textContent = ''; 
        } else {
            // é€šå¸¸ã®ç§»å‹• (ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹çŠ¶æ…‹)
            rollDiceBtn.textContent = 'ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã‚‹';
            rollDiceBtn.disabled = false;
            messageArea.style.backgroundColor = '#e0ffff'; // é€šå¸¸è‰²
            if (!messageArea.textContent.includes('ã‚´ãƒ¼ãƒ«') && 
                !messageArea.textContent.includes('è¬ã‚’è§£ã„ãŸ') && 
                !messageArea.textContent.includes('æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸é€²ã‚“ã§ãã ã•ã„') 
            ) {
                 messageArea.textContent = 'ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦é€²ã¿ã¾ã—ã‚‡ã†ï¼';
            }
            restChallengeCount = 0; // ä¼‘ã¿çŠ¶æ…‹ã‚’æŠœã‘ãŸã®ã§è©¦è¡Œå›æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
        }
    }


    /**
     * ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½ç½®ã¨ãƒã‚¹ã®çŠ¶æ…‹ã‚’DOMã«åæ˜ ã•ã›ã¾ã™ã€‚
     */
    function updateBoardUI() {
        const squares = document.querySelectorAll('.square');
        squares.forEach(sq => {
            sq.classList.remove('active');
            // æ—¢å­˜ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤
            const existingIcon = sq.querySelector('.player-icon');
            if (existingIcon) {
                sq.removeChild(existingIcon);
            }
        });

        // ç¾åœ¨åœ°ã®ãƒã‚¹ã« 'active' ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
        const currentSquare = document.querySelector(`.square[data-index="${playerPosition}"]`);
        if (currentSquare) {
            currentSquare.classList.add('active');
            
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
            const icon = document.createElement('span');
            icon.classList.add('player-icon');
            icon.textContent = playerIcon;
            currentSquare.appendChild(icon);
        }
    }

    /**
     * ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã®å‡¦ç† (ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º)
     */
    function endGame() {
        isGameOver = true;
        
        // æœ€çµ‚ã‚¹ã‚³ã‚¢ã®è¨ˆç®—: ç¾åœ¨ã®ã‚¹ã‚³ã‚¢ + (ã‚µã‚¤ã‚³ãƒ­å›æ•°ã«å¿œã˜ãŸãƒœãƒ¼ãƒŠã‚¹)
        // å›æ•°ãŒå°‘ãªã„ã»ã©ãƒœãƒ¼ãƒŠã‚¹ãŒé«˜ã„ (BASE_BONUS / å›æ•°)
        const rollBonus = Math.floor(BASE_BONUS / Math.max(1, diceRollCount)); 
        const finalScore = currentScore + rollBonus;
        
        // ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        rollDiceBtn.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†';
        rollDiceBtn.disabled = true;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚»ãƒƒãƒˆ
        modalFinalScore.innerHTML = `
            <div style="font-size: 2.2rem; color: #ff69b4;">${finalScore}ç‚¹</div>
            <div style="margin-top: 15px; font-size: 1rem; font-weight: normal; color: #777;">
                (é“ä¸­ã‚¹ã‚³ã‚¢: ${currentScore}ç‚¹ + å®Œèµ°ãƒœãƒ¼ãƒŠã‚¹: ${rollBonus}ç‚¹ / ${diceRollCount}å›)
            </div>
        `;
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º (CSSã®ä¿®æ­£ã«ã‚ˆã‚Šã€ã“ã‚Œã ã‘ã§æ­£ã—ãè¡¨ç¤ºã•ã‚Œã¾ã™)
        goalModal.style.display = 'flex'; // displayã‚’flexã«ã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æœ‰åŠ¹ã«ã™ã‚‹
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        setTimeout(() => {
            goalModal.classList.add('show');
        }, 10);
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«æ›´æ–°
        messageArea.textContent = 'ã‚´ãƒ¼ãƒ«ã—ã¾ã—ãŸï¼æœ€çµ‚çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        messageArea.style.backgroundColor = '#90ee90'; /* ãƒ©ã‚¤ãƒˆã‚°ãƒªãƒ¼ãƒ³ */
        diceResultDisplay.textContent = ''; // ã‚µã‚¤ã‚³ãƒ­çµæœè¡¨ç¤ºã¯ã‚¯ãƒªã‚¢
    }

    /**
     * ã‚µã‚¤ã‚³ãƒ­ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
     */
    function handleRollDice() {
        if (isGameOver || rollDiceBtn.disabled || isPausedByChoice) return;
        
        rollDiceBtn.disabled = true; // é€£æ‰“é˜²æ­¢

        if (turnToSkip > 0) {
            // ä¼‘ã¿ã‹ã‚‰ã®å†é–‹ã‚’è©¦ã¿ã‚‹ (éºè·¡ãƒã‚¹)
            handleRestRoll(); 
        } else if (isPausedByEvent) {
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºä¸­ or ç§»å‹•å®Œäº†å¾Œ
            continueAfterEvent();
        } else {
            // é€šå¸¸ã®ç§»å‹•
            const steps = rollDice();
            
            // ã‚µã‚¤ã‚³ãƒ­å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ (ç§»å‹•ã‚’ä¼´ã†ã‚¿ãƒ¼ãƒ³ã®ã¿)
            diceRollCount++; 
            updateStatsUI();
            
            // ç§»å‹•å‡¦ç†ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ï¼ˆ1.5ç§’ï¼‰ã‚’å¾…ãŸãšã«å³åº§ã«é–‹å§‹
            movePlayer(steps);
        }
    }
    
    /**
     * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆã‚²ãƒ¼ãƒ çµ‚äº†ï¼‰
     */
    function closeModal() {
        // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚²ãƒ¼ãƒ ã‚’æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã™
        window.location.reload(); 
    }


    /**
     * ã‚²ãƒ¼ãƒ ã®é–‹å§‹
     */
    function startGame() {
        initializeBoard();
        playerPosition = 0;
        turnToSkip = 0;
        isPausedByEvent = false;
        isPausedByChoice = false; // åˆæœŸåŒ–ã‚’è¿½åŠ 
        eventToProcess = null;
        choiceEventToProcess = null; // åˆæœŸåŒ–ã‚’è¿½åŠ 
        currentChoiceConsequence = null; // åˆæœŸåŒ–ã‚’è¿½åŠ 
        isGameOver = false;
        diceRollCount = 0;
        currentScore = 1000;
        restChallengeCount = 0;
        diceResultDisplay.textContent = '';
        updateBoardUI();
        updateChoiceUI(); // é¸æŠè‚¢UIã‚‚åˆæœŸåŒ–
        updateRollButtonState();
        updateStatsUI(); // çµ±è¨ˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
        messageArea.textContent = 'ã‚µã‚¤ã‚³ãƒ­ã‚’æŒ¯ã£ã¦ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼';
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤ºã«æˆ»ã—ã¦ãŠã (CSSã§hidden/opacityã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã€display: none;ã¯ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã§æ®‹ã—ã¦ã„ã¾ã™)
        goalModal.style.display = 'none';
        goalModal.classList.remove('show');
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    rollDiceBtn.addEventListener('click', handleRollDice);
    modalCloseBtn.addEventListener('click', closeModal); // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    choiceRollDiceBtn.addEventListener('click', handleChoiceRoll); // é¸æŠè‚¢ã®ã‚µã‚¤ã‚³ãƒ­ãƒœã‚¿ãƒ³

    // --- å®Ÿè¡Œ ---
    window.onload = startGame;

</script>

</body>
</html>